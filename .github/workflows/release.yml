name: Release

on:
  workflow_dispatch:
    inputs:
      version_bump:
        description: 'バージョンのインクリメント方法を選択'
        required: true
        type: choice
        options:
          - major
          - minor
          - patch
        default: 'patch'

permissions:
  contents: write

jobs:
  bump-version:
    name: Bump version
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "24"

      - name: Configure Git
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'

      - name: Bump version
        id: version
        run: |
          npm version ${{ inputs.version_bump }}
          VERSION=$(node -p "require('./package.json').version")
          echo "version=v${VERSION}" >> "$GITHUB_OUTPUT"
          echo "Bumped version to: v${VERSION}"

      - name: Push commit and tag
        run: |
          git push origin HEAD
          git push origin "${{ steps.version.outputs.version }}"

  build-macos:
    name: Build (macOS)
    needs: bump-version
    runs-on: macos-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "24"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Setup Apple API key
        env:
          APPLE_API_KEY_BASE64: ${{ secrets.APPLE_API_KEY_BASE64 }}
          APPLE_API_KEY_ID: ${{ vars.APPLE_API_KEY_ID }}
        run: |
          mkdir -p ~/private_keys
          echo "$APPLE_API_KEY_BASE64" | base64 --decode > ~/private_keys/AuthKey_${APPLE_API_KEY_ID}.p8

      - name: Build and package
        run: npm run package
        env:
          CSC_LINK: ${{ secrets.APPLE_CERTIFICATE_BASE64 }}
          CSC_KEY_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
          APPLE_API_KEY: ~/private_keys/AuthKey_${{ vars.APPLE_API_KEY_ID }}.p8
          APPLE_API_KEY_ID: ${{ vars.APPLE_API_KEY_ID }}
          APPLE_API_ISSUER: ${{ vars.APPLE_API_ISSUER }}

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: release-macos
          path: |
            release/*.dmg
            release/*.zip
            release/*.yml
            release/*.blockmap

  build-windows:
    name: Build (Windows)
    needs: bump-version
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "24"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Build and package
        run: npm run package

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: release-windows
          path: |
            release/*.exe
            release/*.zip
            release/*.yml
            release/*.blockmap

  # build-linux:
  #   name: Build (Linux)
  #   needs: bump-version
  #   runs-on: ubuntu-latest
  #
  #   steps:
  #     - name: Checkout repository
  #       uses: actions/checkout@v4
  #
  #     - name: Setup Node.js
  #       uses: actions/setup-node@v4
  #       with:
  #         node-version: "24"
  #         cache: "npm"
  #
  #     - name: Install dependencies
  #       run: npm ci
  #
  #     - name: Build and package
  #       run: npm run package
  #
  #     - name: Upload artifact
  #       uses: actions/upload-artifact@v4
  #       with:
  #         name: release-linux
  #         path: release/*.AppImage

  create-release:
    name: Create release
    needs:
      - bump-version
      - build-macos
      - build-windows
      # - build-linux
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          pattern: release-*

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.bump-version.outputs.version }}
          generate_release_notes: true
          files: artifacts/**/*
