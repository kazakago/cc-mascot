---
model: sonnet
description: 変更をコミット・プッシュし、PRを作成します。option：[-b <branch>] [-d (draft)] [-p (prompt付与)]
argument-hint: [-b <branch>] [-d (draft)] [-p (prompt付与)]

mode: agent
---

# コミット・プッシュ・PR作成

変更をコミット・プッシュし、PRを作成するまでを一括で実行します。

## 1. 引数のパース

引数は以下のオプションを受け付けます:

- `-b <branch>`: ベースブランチを指定（デフォルト: `main`）
- `-d`: ドラフトPRとして作成
- `-p`: セッションのプロンプトをPR本文に付与

例:

- `/commit-push-pr` → mainベースで通常PR
- `/commit-push-pr -b production` → productionベースで通常PR
- `/commit-push-pr -d` → mainベースでドラフトPR
- `/commit-push-pr -b production -d` → productionベースでドラフトPR
- `/commit-push-pr -p` → mainベースで通常PR（プロンプト付き）
- `/commit-push-pr -b production -d -p` → productionベースでドラフトPR（プロンプト付き）

## 2. ベースブランチの決定

- `-b`オプションが指定されている場合: そのブランチをベースにする
- `-b`オプションが指定されていない場合: `main` をベースにする

## 3. ブランチのチェック

現在のブランチとベースブランチを確認します。

1. 現在のブランチ名を取得:

```bash
git branch --show-current
```

2. 保護されたブランチ一覧を取得:

下記コマンドの:ownerと:repoには現在のgit URLから取得した情報をそれぞれ入れてください

```bash
gh api repos/:owner/:repo/branches --paginate --jq '.[] | select(.protected) | .name'
```

3. 現在のブランチがベースブランチと同じ、または現在のブランチが保護されたブランチの場合:
   - `AskUserQuestion`ツールで新しいブランチ名を提案し、ユーザーに確認
   - 承認された場合: `git checkout -b <ブランチ名>` でブランチを作成し、処理を継続
   - キャンセルされた場合: 処理を中断

4. 現在のブランチがベースブランチと異なる、かつ現在のブランチが保護されていない場合:
   - そのまま次のステップに進む

## 4. 現在の状態確認

```bash
git status
```

変更がない場合は処理を中断してください。

## 5. コミット戦略

- ステージング済み・未ステージングにかかわらず、すべての変更を対象にコミットを提案すること
- 同一ファイルがステージング済みと未ステージングに分かれていても、そのファイルの変更は1つのコミットにまとめること
- 変更内容を意味のある単位で複数のコミットに分割すること
- 1つのコミットには1つの目的のみを含める
- コミットの粒度は、コミットメッセージがワンライン（1行）で記述できる範囲に留めること
  - ワンラインで説明しきれない変更は、さらに細かく分割する
- コミットメッセージは日本語で記述する

### 悪い例

```
fix: 複数の不具合を修正
```

### 良い例

```
:bug: ログイン画面でキーボードが閉じない問題を修正
:bug: ユーザー名表示時の文字化けを修正
```

## 6. ステージングの整理

コミットを実行する前に、既存のステージング状態を確認し、必要に応じて整理してください。

```bash
# 既にステージングされているファイルがある場合、一旦すべてアンステージする
git reset HEAD
```

意味のある粒度でコミットを分割するために、各コミットごとに必要なファイルのみをステージングしてください。

## 7. コミット実行

変更をステージングしてコミットしてください。各コミットは以下の手順で行います：

1. 対象ファイルをステージング: `git add <ファイル>`
2. コミット実行: `git commit -m "<メッセージ>"`
3. 次のコミットのために1-2を繰り返す

## 8. リモートにプッシュ

```bash
git push -u origin <現在のブランチ名>
```

プッシュに失敗した場合は、エラーメッセージを表示して処理を中断してください。

## 9. プロンプト取得（-pオプション指定時のみ）

`-p`オプションが指定されている場合、以下の手順でプロンプトを取得してください:

1. `/export-prompt` コマンドを実行してセッションのプロンプトを取得する
2. 取得したプロンプトを保持しておく（後のPR本文作成で使用）

## 10. 事前確認

```bash
git log --oneline <ベースブランチ>..HEAD
git diff <ベースブランチ>...HEAD --stat
```

## 11. PR作成

テンプレート(@.github/PULL_REQUEST_TEMPLATE.md )を使用してPR本文を作成してください。

### PRタイトルと説明欄の自動生成

- PRタイトル: コミットログの内容を要約して日本語で簡潔に表現
- なにをやったか: コミットログを分析し自動生成
- なぜやったのか: コミットログを分析し自動生成

**重要**: ユーザーに入力を求めて停止してはいけません。コミットログから自動的に生成してください。

### プロンプトの記載（-pオプション指定時のみ）

`-p`オプションが指定されている場合、テンプレートの最後に以下の形式で追記してください:

`````markdown
## :robot: プロンプト

<details>
<summary>プロンプト</summary>
<p>

```
[取得したプロンプト内容]
```

</p>
</details>
`````

### LLMとの共著であることを明記

PR説明欄の最後にこのPRのタイトルと説明が共著であることを下記のように明記してください。
モデル名には自身のLLMモデル名をいれてください。

```markdown
---

Co-Written-By: [LLMモデル名]
```

## 12. ghコマンドでPR作成

```bash
# 通常PRの場合
gh pr create --base <ベースブランチ> --title "<PRタイトル>" --body "<本文>"

# ドラフトPRの場合（-dオプション指定時）
gh pr create --base <ベースブランチ> --title "<PRタイトル>" --body "<本文>" --draft
```

- タイトルは日本語で、変更内容を簡潔に表現してください
- 本文はテンプレートに沿って記述してください
- 関連URLにリンクを記載する場合は、404ではなく正しくアクセスできるURLであることを確認してください
- 関連URLには、変更対象のファイルへのリンクは記載しないでください（PRのdiffで確認できるため）
- 関連URLは意味のあるリンクのみ記載してください。不要であれば空欄でも構いません

## 注意事項

- **このコマンドは最後まで必ず実行してください。途中でユーザーに入力を求めて停止してはいけません（ラベル付与の確認を除く）**
- エラーが発生した場合は、エラーメッセージを表示して処理を中断してください
- すべての記述（コミットメッセージ、PRタイトル、PR本文）は日本語で行ってください
- 関連性のない変更は別々のコミットに分けてください
